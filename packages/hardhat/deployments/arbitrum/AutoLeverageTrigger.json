{
  "address": "0x148E524518BE97020fCb72a12a46978491168331",
  "abi": [
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_viewRouter",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [],
      "name": "InvalidTriggerParams",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "AAVE_V3",
      "outputs": [
        {
          "internalType": "bytes4",
          "name": "",
          "type": "bytes4"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "COMPOUND_V3",
      "outputs": [
        {
          "internalType": "bytes4",
          "name": "",
          "type": "bytes4"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "EULER_V2",
      "outputs": [
        {
          "internalType": "bytes4",
          "name": "",
          "type": "bytes4"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "MORPHO_BLUE",
      "outputs": [
        {
          "internalType": "bytes4",
          "name": "",
          "type": "bytes4"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes",
          "name": "staticData",
          "type": "bytes"
        },
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        }
      ],
      "name": "calculateExecution",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "sellAmount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "minBuyAmount",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "components": [
            {
              "internalType": "bytes4",
              "name": "protocolId",
              "type": "bytes4"
            },
            {
              "internalType": "bytes",
              "name": "protocolContext",
              "type": "bytes"
            },
            {
              "internalType": "uint256",
              "name": "triggerLtvBps",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "targetLtvBps",
              "type": "uint256"
            },
            {
              "internalType": "address",
              "name": "collateralToken",
              "type": "address"
            },
            {
              "internalType": "address",
              "name": "debtToken",
              "type": "address"
            },
            {
              "internalType": "uint8",
              "name": "collateralDecimals",
              "type": "uint8"
            },
            {
              "internalType": "uint8",
              "name": "debtDecimals",
              "type": "uint8"
            },
            {
              "internalType": "uint256",
              "name": "maxSlippageBps",
              "type": "uint256"
            },
            {
              "internalType": "uint8",
              "name": "numChunks",
              "type": "uint8"
            }
          ],
          "internalType": "struct AutoLeverageTrigger.TriggerParams",
          "name": "params",
          "type": "tuple"
        }
      ],
      "name": "encodeTriggerParams",
      "outputs": [
        {
          "internalType": "bytes",
          "name": "",
          "type": "bytes"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes4",
          "name": "protocolId",
          "type": "bytes4"
        },
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "bytes",
          "name": "context",
          "type": "bytes"
        }
      ],
      "name": "getCurrentLtv",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes",
          "name": "",
          "type": "bytes"
        },
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "isComplete",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes",
          "name": "staticData",
          "type": "bytes"
        },
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        }
      ],
      "name": "shouldExecute",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        },
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "triggerName",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "viewRouter",
      "outputs": [
        {
          "internalType": "contract IKapanViewRouter",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ],
  "transactionHash": "0xaf80821d0280199c9fa860f8b01ebf99f6eec0f99bb13a9d19252a4c4d52c64a",
  "receipt": {
    "to": "0x4e59b44847b379578588920cA78FbF26c0B4956C",
    "from": "0x0BE61223F99E57b8b8B7033a77B54Adc7f7cF027",
    "contractAddress": null,
    "transactionIndex": 6,
    "gasUsed": "875349",
    "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "blockHash": "0x419e8213af0750f2e8aa03215f57c3814436234571bdb2808e1515ba2ecee8d6",
    "transactionHash": "0xaf80821d0280199c9fa860f8b01ebf99f6eec0f99bb13a9d19252a4c4d52c64a",
    "logs": [],
    "blockNumber": 426954716,
    "cumulativeGasUsed": "1293254",
    "status": 1,
    "byzantium": true
  },
  "args": [
    "0x7b25A93c8a090C589030f3c3cDEec52Ffd5Ce9d1"
  ],
  "numDeployments": 6,
  "solcInputHash": "2cbc89d833afca45c100fa45cc6b6f2b",
  "metadata": "{\"compiler\":{\"version\":\"0.8.30+commit.73712a01\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_viewRouter\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[],\"name\":\"InvalidTriggerParams\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"AAVE_V3\",\"outputs\":[{\"internalType\":\"bytes4\",\"name\":\"\",\"type\":\"bytes4\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"COMPOUND_V3\",\"outputs\":[{\"internalType\":\"bytes4\",\"name\":\"\",\"type\":\"bytes4\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"EULER_V2\",\"outputs\":[{\"internalType\":\"bytes4\",\"name\":\"\",\"type\":\"bytes4\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"MORPHO_BLUE\",\"outputs\":[{\"internalType\":\"bytes4\",\"name\":\"\",\"type\":\"bytes4\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes\",\"name\":\"staticData\",\"type\":\"bytes\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"calculateExecution\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"sellAmount\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"minBuyAmount\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"components\":[{\"internalType\":\"bytes4\",\"name\":\"protocolId\",\"type\":\"bytes4\"},{\"internalType\":\"bytes\",\"name\":\"protocolContext\",\"type\":\"bytes\"},{\"internalType\":\"uint256\",\"name\":\"triggerLtvBps\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"targetLtvBps\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"collateralToken\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"debtToken\",\"type\":\"address\"},{\"internalType\":\"uint8\",\"name\":\"collateralDecimals\",\"type\":\"uint8\"},{\"internalType\":\"uint8\",\"name\":\"debtDecimals\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"maxSlippageBps\",\"type\":\"uint256\"},{\"internalType\":\"uint8\",\"name\":\"numChunks\",\"type\":\"uint8\"}],\"internalType\":\"struct AutoLeverageTrigger.TriggerParams\",\"name\":\"params\",\"type\":\"tuple\"}],\"name\":\"encodeTriggerParams\",\"outputs\":[{\"internalType\":\"bytes\",\"name\":\"\",\"type\":\"bytes\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes4\",\"name\":\"protocolId\",\"type\":\"bytes4\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"bytes\",\"name\":\"context\",\"type\":\"bytes\"}],\"name\":\"getCurrentLtv\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes\",\"name\":\"\",\"type\":\"bytes\"},{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"isComplete\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes\",\"name\":\"staticData\",\"type\":\"bytes\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"shouldExecute\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"},{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"triggerName\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"viewRouter\",\"outputs\":[{\"internalType\":\"contract IKapanViewRouter\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"}],\"devdoc\":{\"details\":\"Opposite of LtvTrigger - increases leverage when under-leveraged Flow: 1. Pre-hook: Flash loan collateral \\u2192 Deposit \\u2192 Borrow debt \\u2192 Push to OrderManager 2. CoW Swap: Debt \\u2192 Collateral 3. Post-hook: Repay flash loan with received collateral Order params:   - sellToken = debtToken (we're selling borrowed debt)   - buyToken = collateralToken (we're buying collateral to repay flash loan)\",\"kind\":\"dev\",\"methods\":{\"calculateExecution(bytes,address)\":{\"details\":\"Returns:   - sellAmount: debt tokens to borrow and swap   - minBuyAmount: collateral tokens expected (must cover flash loan + fee)\",\"params\":{\"owner\":\"The order owner\",\"staticData\":\"ABI-encoded trigger-specific parameters\"},\"returns\":{\"minBuyAmount\":\"Minimum amount to receive (includes slippage protection)\",\"sellAmount\":\"Amount of sell token to trade in this execution\"}},\"isComplete(bytes,address,uint256)\":{\"details\":\"Auto-leverage orders are continuous - they never auto-complete. The order remains active and will re-trigger whenever LTV drops below the trigger threshold, up to maxIterations or until user cancels. This provides ongoing leverage management rather than one-shot execution.\",\"params\":{\"iterationCount\":\"Number of executions completed so far\",\"owner\":\"The order owner\",\"staticData\":\"ABI-encoded trigger-specific parameters\"},\"returns\":{\"_0\":\"True if the order goal has been reached\"}},\"shouldExecute(bytes,address)\":{\"params\":{\"owner\":\"The order owner (user whose position is being monitored)\",\"staticData\":\"ABI-encoded trigger-specific parameters\"},\"returns\":{\"_0\":\"True if the trigger condition is met\",\"_1\":\"Human-readable reason for the result (for debugging/logging)\"}},\"triggerName()\":{\"returns\":{\"_0\":\"Trigger name (e.g., \\\"LTV\\\", \\\"Price\\\", \\\"HealthFactor\\\")\"}}},\"title\":\"AutoLeverageTrigger\",\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{\"calculateExecution(bytes,address)\":{\"notice\":\"Calculate the execution amounts when the trigger fires\"},\"encodeTriggerParams((bytes4,bytes,uint256,uint256,address,address,uint8,uint8,uint256,uint8))\":{\"notice\":\"Encode trigger params for order creation\"},\"getCurrentLtv(bytes4,address,bytes)\":{\"notice\":\"Get current LTV for a user\"},\"isComplete(bytes,address,uint256)\":{\"notice\":\"Check if the order is complete and should stop executing\"},\"shouldExecute(bytes,address)\":{\"notice\":\"Check if the order should execute based on current conditions\"},\"triggerName()\":{\"notice\":\"Get human-readable name of the trigger type\"}},\"notice\":\"Triggers order execution when position LTV drops BELOW a threshold (auto-leverage)\",\"version\":1}},\"settings\":{\"compilationTarget\":{\"contracts/v2/triggers/AutoLeverageTrigger.sol\":\"AutoLeverageTrigger\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\",\"useLiteralContent\":true},\"optimizer\":{\"enabled\":true,\"runs\":10},\"remappings\":[],\"viaIR\":true},\"sources\":{\"contracts/v2/interfaces/IOrderTrigger.sol\":{\"content\":\"// SPDX-License-Identifier: MIT\\npragma solidity ^0.8.30;\\n\\n/// @title IOrderTrigger\\n/// @notice Interface for pluggable order triggers in the Kapan conditional order system\\n/// @dev Triggers determine when an order should execute and how much to trade\\ninterface IOrderTrigger {\\n    /// @notice Check if the order should execute based on current conditions\\n    /// @param staticData ABI-encoded trigger-specific parameters\\n    /// @param owner The order owner (user whose position is being monitored)\\n    /// @return shouldExecute True if the trigger condition is met\\n    /// @return reason Human-readable reason for the result (for debugging/logging)\\n    function shouldExecute(\\n        bytes calldata staticData,\\n        address owner\\n    ) external view returns (bool shouldExecute, string memory reason);\\n\\n    /// @notice Calculate the execution amounts when the trigger fires\\n    /// @dev Only called when shouldExecute returns true\\n    /// @param staticData ABI-encoded trigger-specific parameters\\n    /// @param owner The order owner\\n    /// @return sellAmount Amount of sell token to trade in this execution\\n    /// @return minBuyAmount Minimum amount to receive (includes slippage protection)\\n    function calculateExecution(\\n        bytes calldata staticData,\\n        address owner\\n    ) external view returns (uint256 sellAmount, uint256 minBuyAmount);\\n\\n    /// @notice Check if the order is complete and should stop executing\\n    /// @dev Called after each execution to determine if order should be marked complete\\n    /// @param staticData ABI-encoded trigger-specific parameters\\n    /// @param owner The order owner\\n    /// @param iterationCount Number of executions completed so far\\n    /// @return complete True if the order goal has been reached\\n    function isComplete(\\n        bytes calldata staticData,\\n        address owner,\\n        uint256 iterationCount\\n    ) external view returns (bool complete);\\n\\n    /// @notice Get human-readable name of the trigger type\\n    /// @return name Trigger name (e.g., \\\"LTV\\\", \\\"Price\\\", \\\"HealthFactor\\\")\\n    function triggerName() external pure returns (string memory name);\\n}\\n\",\"keccak256\":\"0x0a4632796415a05e04d2d42eabc5691183c2c0b98088fd47e8a939d30c11a308\",\"license\":\"MIT\"},\"contracts/v2/triggers/AutoLeverageTrigger.sol\":{\"content\":\"// SPDX-License-Identifier: MIT\\npragma solidity ^0.8.30;\\n\\nimport { IOrderTrigger } from \\\"../interfaces/IOrderTrigger.sol\\\";\\n\\n/// @notice Morpho Blue MarketParams structure\\nstruct MarketParams {\\n    address loanToken;\\n    address collateralToken;\\n    address oracle;\\n    address irm;\\n    uint256 lltv;\\n}\\n\\n/// @title KapanViewRouter Interface (same as LtvTrigger)\\ninterface IKapanViewRouter {\\n    function getCurrentLtv(bytes4 protocolId, address user, bytes calldata context) external view returns (uint256 ltvBps);\\n    function getPositionValue(bytes4 protocolId, address user, bytes calldata context) external view returns (uint256 collateralValueUsd, uint256 debtValueUsd);\\n    function getCollateralPrice(bytes4 protocolId, address collateralToken, bytes calldata context) external view returns (uint256 price);\\n    function getDebtPrice(bytes4 protocolId, address debtToken, bytes calldata context) external view returns (uint256 price);\\n    function getMorphoOraclePrice(MarketParams calldata params) external view returns (uint256 price);\\n}\\n\\n/// @title AutoLeverageTrigger\\n/// @notice Triggers order execution when position LTV drops BELOW a threshold (auto-leverage)\\n/// @dev Opposite of LtvTrigger - increases leverage when under-leveraged\\n///\\n/// Flow:\\n/// 1. Pre-hook: Flash loan collateral \\u2192 Deposit \\u2192 Borrow debt \\u2192 Push to OrderManager\\n/// 2. CoW Swap: Debt \\u2192 Collateral\\n/// 3. Post-hook: Repay flash loan with received collateral\\n///\\n/// Order params:\\n///   - sellToken = debtToken (we're selling borrowed debt)\\n///   - buyToken = collateralToken (we're buying collateral to repay flash loan)\\ncontract AutoLeverageTrigger is IOrderTrigger {\\n    // ============ Errors ============\\n    error InvalidTriggerParams();\\n\\n    // ============ Constants ============\\n    bytes4 public constant AAVE_V3 = bytes4(keccak256(\\\"aave-v3\\\"));\\n    bytes4 public constant COMPOUND_V3 = bytes4(keccak256(\\\"compound-v3\\\"));\\n    bytes4 public constant MORPHO_BLUE = bytes4(keccak256(\\\"morpho-blue\\\"));\\n    bytes4 public constant EULER_V2 = bytes4(keccak256(\\\"euler-v2\\\"));\\n\\n    // ============ Immutables ============\\n    IKapanViewRouter public immutable viewRouter;\\n\\n    // ============ Structs ============\\n\\n    /// @notice Trigger parameters for LTV-based auto-leverage\\n    struct TriggerParams {\\n        bytes4 protocolId;          // Protocol identifier\\n        bytes protocolContext;       // Protocol-specific data\\n        uint256 triggerLtvBps;       // LTV threshold BELOW which to trigger (e.g., 5000 = 50%)\\n        uint256 targetLtvBps;        // Target LTV after leverage (e.g., 7000 = 70%)\\n        address collateralToken;     // Token to BUY (receive from swap, repay flash loan)\\n        address debtToken;           // Token to SELL (borrow and swap)\\n        uint8 collateralDecimals;\\n        uint8 debtDecimals;\\n        uint256 maxSlippageBps;      // Maximum slippage tolerance\\n        uint8 numChunks;             // Number of chunks (1 = full amount)\\n    }\\n\\n    // ============ Constructor ============\\n\\n    constructor(address _viewRouter) {\\n        if (_viewRouter == address(0)) revert InvalidTriggerParams();\\n        viewRouter = IKapanViewRouter(_viewRouter);\\n    }\\n\\n    // ============ IOrderTrigger Implementation ============\\n\\n    /// @inheritdoc IOrderTrigger\\n    function shouldExecute(\\n        bytes calldata staticData,\\n        address owner\\n    ) external view override returns (bool, string memory) {\\n        TriggerParams memory params = abi.decode(staticData, (TriggerParams));\\n\\n        uint256 currentLtv = viewRouter.getCurrentLtv(params.protocolId, owner, params.protocolContext);\\n\\n        if (currentLtv == 0) {\\n            return (false, \\\"No position\\\");\\n        }\\n\\n        // Trigger when UNDER-leveraged (LTV too low)\\n        if (currentLtv < params.triggerLtvBps) {\\n            return (true, \\\"LTV below threshold - under-leveraged\\\");\\n        }\\n\\n        return (false, \\\"LTV above threshold\\\");\\n    }\\n\\n    /// @inheritdoc IOrderTrigger\\n    /// @dev Returns:\\n    ///   - sellAmount: debt tokens to borrow and swap\\n    ///   - minBuyAmount: collateral tokens expected (must cover flash loan + fee)\\n    function calculateExecution(\\n        bytes calldata staticData,\\n        address owner\\n    ) external view override returns (uint256 sellAmount, uint256 minBuyAmount) {\\n        TriggerParams memory params = abi.decode(staticData, (TriggerParams));\\n\\n        // Get current position value in USD (8 decimals)\\n        (uint256 collateralValueUsd, uint256 debtValueUsd) = viewRouter.getPositionValue(\\n            params.protocolId,\\n            owner,\\n            params.protocolContext\\n        );\\n\\n        if (collateralValueUsd == 0) return (0, 0);\\n\\n        uint256 currentLtv = (debtValueUsd * 10000) / collateralValueUsd;\\n        if (currentLtv >= params.targetLtvBps) return (0, 0); // Already at or above target\\n\\n        // Calculate how much additional debt (in USD) to reach target LTV\\n        //\\n        // After leverage:\\n        //   newDebt / newCollateral = targetLTV\\n        //   (D + \\u0394D) / (C + \\u0394C) = targetLTV\\n        //\\n        // Where \\u0394C \\u2248 \\u0394D (collateral received from swapping debt, roughly 1:1 in USD value)\\n        //\\n        // Solving for \\u0394D:\\n        //   D + \\u0394D = targetLTV \\u00d7 (C + \\u0394D)\\n        //   D + \\u0394D = targetLTV \\u00d7 C + targetLTV \\u00d7 \\u0394D\\n        //   \\u0394D \\u00d7 (1 - targetLTV) = targetLTV \\u00d7 C - D\\n        //   \\u0394D = (targetLTV \\u00d7 C - D) / (1 - targetLTV)\\n        //\\n        // This is the inverse of the ADL formula (which reduces both C and D)\\n        uint256 targetDebtUsd = (params.targetLtvBps * collateralValueUsd) / 10000;\\n        if (targetDebtUsd <= debtValueUsd) return (0, 0); // Already at or above target\\n\\n        uint256 numerator = targetDebtUsd - debtValueUsd;\\n        uint256 denominator = 10000 - params.targetLtvBps;\\n        if (denominator == 0) return (0, 0); // Prevent division by zero at 100% LTV\\n\\n        uint256 deltaDebtUsd = (numerator * 10000) / denominator;\\n\\n        // Convert USD to debt token amount\\n        uint256 debtPrice = viewRouter.getDebtPrice(params.protocolId, params.debtToken, params.protocolContext);\\n        sellAmount = (deltaDebtUsd * (10 ** params.debtDecimals)) / debtPrice;\\n\\n        // Apply chunking\\n        uint8 chunks = params.numChunks > 0 ? params.numChunks : 1;\\n        if (chunks > 1) {\\n            sellAmount = sellAmount / chunks;\\n        }\\n\\n        if (sellAmount == 0) return (0, 0);\\n\\n        // Calculate minBuyAmount (collateral) with slippage\\n        // This must cover the flash loan repayment\\n        uint256 expectedCollateral;\\n\\n        if (params.protocolId == MORPHO_BLUE) {\\n            // Morpho uses a special oracle that returns collateral/debt exchange rate at 36 decimals\\n            // Formula: collateralAmount = debtAmount * 1e36 / oraclePrice\\n            // The oracle accounts for decimal differences between tokens\\n            MarketParams memory marketParams = abi.decode(params.protocolContext, (MarketParams));\\n            uint256 morphoOraclePrice = viewRouter.getMorphoOraclePrice(marketParams);\\n            if (morphoOraclePrice > 0) {\\n                // sellAmount is in debt token decimals, result is in collateral token decimals\\n                expectedCollateral = (sellAmount * 1e36) / morphoOraclePrice;\\n            }\\n        } else {\\n            // Standard price-based calculation for other protocols\\n            uint256 collateralPrice = viewRouter.getCollateralPrice(\\n                params.protocolId,\\n                params.collateralToken,\\n                params.protocolContext\\n            );\\n\\n            if (collateralPrice > 0) {\\n                // Expected collateral = sellAmount(debt) \\u00d7 debtPrice / collateralPrice\\n                expectedCollateral = (sellAmount * debtPrice) / collateralPrice;\\n                // Adjust for decimals\\n                expectedCollateral = (expectedCollateral * (10 ** params.collateralDecimals)) / (10 ** params.debtDecimals);\\n            }\\n        }\\n\\n        // Apply slippage\\n        minBuyAmount = (expectedCollateral * (10000 - params.maxSlippageBps)) / 10000;\\n    }\\n\\n    /// @inheritdoc IOrderTrigger\\n    /// @dev Auto-leverage orders are continuous - they never auto-complete.\\n    /// The order remains active and will re-trigger whenever LTV drops below\\n    /// the trigger threshold, up to maxIterations or until user cancels.\\n    /// This provides ongoing leverage management rather than one-shot execution.\\n    function isComplete(\\n        bytes calldata /* staticData */,\\n        address /* owner */,\\n        uint256 /* iterationCount */\\n    ) external pure override returns (bool) {\\n        // Never auto-complete - rely on maxIterations for termination\\n        return false;\\n    }\\n\\n    /// @inheritdoc IOrderTrigger\\n    function triggerName() external pure override returns (string memory) {\\n        return \\\"AutoLeverage\\\";\\n    }\\n\\n    // ============ View Helpers ============\\n\\n    /// @notice Get current LTV for a user\\n    function getCurrentLtv(bytes4 protocolId, address owner, bytes calldata context) external view returns (uint256) {\\n        return viewRouter.getCurrentLtv(protocolId, owner, context);\\n    }\\n\\n    /// @notice Encode trigger params for order creation\\n    function encodeTriggerParams(TriggerParams memory params) external pure returns (bytes memory) {\\n        return abi.encode(params);\\n    }\\n\\n}\\n\",\"keccak256\":\"0xf59a9169a20e0a1f4b370c24e947aba84c9dc5b491a8413ed53398d577267979\",\"license\":\"MIT\"}},\"version\":1}",
  "bytecode": "0x60a03461009657601f610f7a38819003918201601f19168301916001600160401b0383118484101761009a5780849260209460405283398101031261009657516001600160a01b0381169081900361009657801561008757608052604051610ecb90816100af8239608051818181610374015281816104a8015281816108890152610d6d0152f35b63f77479dd60e01b5f5260045ffd5b5f80fd5b634e487b7160e01b5f52604160045260245ffdfe6080806040526004361015610012575f80fd5b5f3560e01c9081633131489f1461053e57508063321394961461051c57806343fc0865146104d75780634f1cb2911461049357806356a914f61461046e578063632224a71461043857806390359bcc1461041657806399fec7a0146103f45780639de73085146102d1578063b030ddb3146100eb5763dd90a89114610095575f80fd5b346100e7575f3660031901126100e7576100e36040516100b660408261065f565b600c81526b4175746f4c6576657261676560a01b60208201526040519182916020835260208301906105f6565b0390f35b5f80fd5b346100e75760203660031901126100e7576004356001600160401b0381116100e75761014060031982360301126100e7576040516101288161062f565b6101348260040161061a565b815260248201356001600160401b0381116100e757820191366023840112156100e757600483013561016581610682565b93610173604051958661065f565b81855236602482840101116100e7576024829101602086013783016020015f905260208201928352604082019060448101358252606083019060648101358252608481016101c0906105a0565b608085019081526101d360a483016105a0565b60a086019081526101e660c4840161069d565b60c08701908152906101fa60e4850161069d565b9260e0880193845261010088019461010481013586526101240161021d9061069d565b956101208901968752604051998a9960208b016020905263ffffffff60e01b90511660408b01525160608a0161014090526101808a0161025c916105f6565b975160808a01525160a0890152516001600160a01b0390811660c089015290511660e08701525160ff90811661010087015290518116610120860152905161014085015290511661016083015203601f19810182526102bb908261065f565b604051809160208252602082016100e3916105f6565b346100e75760603660031901126100e75760043563ffffffff60e01b81168091036100e7576102fe61058a565b604435906001600160401b0382116100e7576084610322602093369060040161055d565b604051639de7308560e01b815260048101969096526001600160a01b0390931660248601526060604486015260648501839052849283918190848401375f828201840152601f01601f191681010301817f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165afa80156103e9575f906103b6575b602090604051908152f35b506020813d6020116103e1575b816103d06020938361065f565b810103126100e757602090516103ab565b3d91506103c3565b6040513d5f823e3d90fd5b346100e7575f3660031901126100e757604051633028125760e01b8152602090f35b346100e7575f3660031901126100e757604051633c724fef60e11b8152602090f35b346100e75761044f610449366105b4565b91610d2c565b906100e3604051928392151583526040602084015260408301906105f6565b346100e7576040610487610481366105b4565b91610862565b82519182526020820152f35b346100e7575f3660031901126100e7576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b346100e75760603660031901126100e7576004356001600160401b0381116100e75761050790369060040161055d565b505061051161058a565b5060206040515f8152f35b346100e7575f3660031901126100e75760405163bbbf88eb60e01b8152602090f35b346100e7575f3660031901126100e757633af167ff60e01b8152602090f35b9181601f840112156100e7578235916001600160401b0383116100e757602083818601950101116100e757565b602435906001600160a01b03821682036100e757565b35906001600160a01b03821682036100e757565b60406003198201126100e757600435906001600160401b0382116100e7576105de9160040161055d565b90916024356001600160a01b03811681036100e75790565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b35906001600160e01b0319821682036100e757565b61014081019081106001600160401b0382111761064b57604052565b634e487b7160e01b5f52604160045260245ffd5b601f909101601f19168101906001600160401b0382119082101761064b57604052565b6001600160401b03811161064b57601f01601f191660200190565b359060ff821682036100e757565b6020818303126100e7578035906001600160401b0382116100e7570190610140828203126100e757604051916106e08361062f565b6106e98161061a565b835260208101356001600160401b0381116100e75781019082601f830112156100e75781359261071884610682565b90610726604051928361065f565b848252602085850101116100e7575f6020856107b99682610120970183860137830101526020850152604081013560408501526060810135606085015261076f608082016105a0565b608085015261078060a082016105a0565b60a085015261079160c0820161069d565b60c08501526107a260e0820161069d565b60e08501526101008101356101008501520161069d565b61012082015290565b6001600160e01b031990911681526001600160a01b0390911660208201526060604082018190526107f5929101906105f6565b90565b8181029291811591840414171561080b57565b634e487b7160e01b5f52601160045260245ffd5b8115610829570490565b634e487b7160e01b5f52601260045260245ffd5b60ff16604d811161080b57600a0a90565b51906001600160a01b03821682036100e757565b610871919392938101906106ab565b8051602082018051604080516326a9d0f960e21b81527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169793959490939192849283926108d69291906001600160e01b031916600485016107c2565b0381885afa80156103e9575f915f91610cf3575b508115610ce7576127108102818104612710148215171561080b578261090f9161081f565b916060840192835180911015610cd9576127109161092c916107f8565b0481811115610c7d578181039281841161080b575191826127100392612710841161080b5761271014610cd9576127108402938404612710149114171561080b576109769161081f565b815160a08301518451604051630ee9078360e01b81529397939592602092879283926109b9926001600160a01b0316906001600160e01b031916600485016107c2565b0381855afa9384156103e9575f94610ca5575b506109f1846109ec60e08601986109e660ff8b511661083d565b906107f8565b61081f565b61012084015190969060ff168015610c9b5760ff905b1660018111610c8a575b508615610c7d5783515f95906001600160e01b031916633028125760e01b8103610ba857505050519060a0828051810103126100e7576040519060a082016001600160401b0381118382101761064b5760209260a491604052610a7584860161084e565b8152610a836040860161084e565b92848201938452610a966060870161084e565b956040830196875260a0610aac6080830161084e565b606085019081529101516080840190815260405163168be4db60e01b815293516001600160a01b03908116600486015295518616602485015296518516604484015251909316606482015293516084850152839182905afa9081156103e9575f91610b76575b5080610b40575b50610100905b01516127100390612710821161080b5761271091610b3c916107f8565b0490565b9091506a0c097ce7bc90715b34b9f160241b84810290858204148515171561080b5761010091610b6f9161081f565b9190610b19565b90506020813d602011610ba0575b81610b916020938361065f565b810103126100e757515f610b12565b3d9150610b84565b6020919294610bde9460018060a01b0360808901511690519260405196879485938493630794e50360e01b8552600485016107c2565b03915afa9182156103e9575f92610c49575b5081610c03575b50505061010090610b1f565b61010093945060ff610c32610c23610c4095946109ec610c3a958c6107f8565b6109e68360c08a01511661083d565b92511661083d565b9061081f565b91905f80610bf7565b9091506020813d602011610c75575b81610c656020938361065f565b810103126100e75751905f610bf0565b3d9150610c58565b505050505090505f905f90565b610c94919761081f565b955f610a11565b5060ff6001610a07565b9093506020813d602011610cd1575b81610cc16020938361065f565b810103126100e75751925f6109cc565b3d9150610cb4565b50505050505090505f905f90565b5050505090505f905f90565b9150506040813d604011610d24575b81610d0f6040938361065f565b810103126100e757602081519101515f6108ea565b3d9150610d02565b610d38918101906106ab565b602063ffffffff60e01b825116928183015193610d696040519586938493639de7308560e01b8552600485016107c2565b03817f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165afa9182156103e9575f92610e61575b508115610e34576040015111610de8575f90604051610dc560408261065f565b60138152721315158818589bdd99481d1a1c995cda1bdb19606a1b602082015290565b600190604051610df960608261065f565b602581527f4c54562062656c6f77207468726573686f6c64202d20756e6465722d6c6576656020820152641c9859d95960da1b604082015290565b50505f90604051610e4660408261065f565b600b81526a2737903837b9b4ba34b7b760a91b602082015290565b9091506020813d602011610e8d575b81610e7d6020938361065f565b810103126100e75751905f610da5565b3d9150610e7056fea26469706673582212205cb9ef9264889e9f32806e709709b8f63845c2752d811e5ba07b1e930ff08fff64736f6c634300081e0033",
  "deployedBytecode": "0x6080806040526004361015610012575f80fd5b5f3560e01c9081633131489f1461053e57508063321394961461051c57806343fc0865146104d75780634f1cb2911461049357806356a914f61461046e578063632224a71461043857806390359bcc1461041657806399fec7a0146103f45780639de73085146102d1578063b030ddb3146100eb5763dd90a89114610095575f80fd5b346100e7575f3660031901126100e7576100e36040516100b660408261065f565b600c81526b4175746f4c6576657261676560a01b60208201526040519182916020835260208301906105f6565b0390f35b5f80fd5b346100e75760203660031901126100e7576004356001600160401b0381116100e75761014060031982360301126100e7576040516101288161062f565b6101348260040161061a565b815260248201356001600160401b0381116100e757820191366023840112156100e757600483013561016581610682565b93610173604051958661065f565b81855236602482840101116100e7576024829101602086013783016020015f905260208201928352604082019060448101358252606083019060648101358252608481016101c0906105a0565b608085019081526101d360a483016105a0565b60a086019081526101e660c4840161069d565b60c08701908152906101fa60e4850161069d565b9260e0880193845261010088019461010481013586526101240161021d9061069d565b956101208901968752604051998a9960208b016020905263ffffffff60e01b90511660408b01525160608a0161014090526101808a0161025c916105f6565b975160808a01525160a0890152516001600160a01b0390811660c089015290511660e08701525160ff90811661010087015290518116610120860152905161014085015290511661016083015203601f19810182526102bb908261065f565b604051809160208252602082016100e3916105f6565b346100e75760603660031901126100e75760043563ffffffff60e01b81168091036100e7576102fe61058a565b604435906001600160401b0382116100e7576084610322602093369060040161055d565b604051639de7308560e01b815260048101969096526001600160a01b0390931660248601526060604486015260648501839052849283918190848401375f828201840152601f01601f191681010301817f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165afa80156103e9575f906103b6575b602090604051908152f35b506020813d6020116103e1575b816103d06020938361065f565b810103126100e757602090516103ab565b3d91506103c3565b6040513d5f823e3d90fd5b346100e7575f3660031901126100e757604051633028125760e01b8152602090f35b346100e7575f3660031901126100e757604051633c724fef60e11b8152602090f35b346100e75761044f610449366105b4565b91610d2c565b906100e3604051928392151583526040602084015260408301906105f6565b346100e7576040610487610481366105b4565b91610862565b82519182526020820152f35b346100e7575f3660031901126100e7576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b346100e75760603660031901126100e7576004356001600160401b0381116100e75761050790369060040161055d565b505061051161058a565b5060206040515f8152f35b346100e7575f3660031901126100e75760405163bbbf88eb60e01b8152602090f35b346100e7575f3660031901126100e757633af167ff60e01b8152602090f35b9181601f840112156100e7578235916001600160401b0383116100e757602083818601950101116100e757565b602435906001600160a01b03821682036100e757565b35906001600160a01b03821682036100e757565b60406003198201126100e757600435906001600160401b0382116100e7576105de9160040161055d565b90916024356001600160a01b03811681036100e75790565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b35906001600160e01b0319821682036100e757565b61014081019081106001600160401b0382111761064b57604052565b634e487b7160e01b5f52604160045260245ffd5b601f909101601f19168101906001600160401b0382119082101761064b57604052565b6001600160401b03811161064b57601f01601f191660200190565b359060ff821682036100e757565b6020818303126100e7578035906001600160401b0382116100e7570190610140828203126100e757604051916106e08361062f565b6106e98161061a565b835260208101356001600160401b0381116100e75781019082601f830112156100e75781359261071884610682565b90610726604051928361065f565b848252602085850101116100e7575f6020856107b99682610120970183860137830101526020850152604081013560408501526060810135606085015261076f608082016105a0565b608085015261078060a082016105a0565b60a085015261079160c0820161069d565b60c08501526107a260e0820161069d565b60e08501526101008101356101008501520161069d565b61012082015290565b6001600160e01b031990911681526001600160a01b0390911660208201526060604082018190526107f5929101906105f6565b90565b8181029291811591840414171561080b57565b634e487b7160e01b5f52601160045260245ffd5b8115610829570490565b634e487b7160e01b5f52601260045260245ffd5b60ff16604d811161080b57600a0a90565b51906001600160a01b03821682036100e757565b610871919392938101906106ab565b8051602082018051604080516326a9d0f960e21b81527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169793959490939192849283926108d69291906001600160e01b031916600485016107c2565b0381885afa80156103e9575f915f91610cf3575b508115610ce7576127108102818104612710148215171561080b578261090f9161081f565b916060840192835180911015610cd9576127109161092c916107f8565b0481811115610c7d578181039281841161080b575191826127100392612710841161080b5761271014610cd9576127108402938404612710149114171561080b576109769161081f565b815160a08301518451604051630ee9078360e01b81529397939592602092879283926109b9926001600160a01b0316906001600160e01b031916600485016107c2565b0381855afa9384156103e9575f94610ca5575b506109f1846109ec60e08601986109e660ff8b511661083d565b906107f8565b61081f565b61012084015190969060ff168015610c9b5760ff905b1660018111610c8a575b508615610c7d5783515f95906001600160e01b031916633028125760e01b8103610ba857505050519060a0828051810103126100e7576040519060a082016001600160401b0381118382101761064b5760209260a491604052610a7584860161084e565b8152610a836040860161084e565b92848201938452610a966060870161084e565b956040830196875260a0610aac6080830161084e565b606085019081529101516080840190815260405163168be4db60e01b815293516001600160a01b03908116600486015295518616602485015296518516604484015251909316606482015293516084850152839182905afa9081156103e9575f91610b76575b5080610b40575b50610100905b01516127100390612710821161080b5761271091610b3c916107f8565b0490565b9091506a0c097ce7bc90715b34b9f160241b84810290858204148515171561080b5761010091610b6f9161081f565b9190610b19565b90506020813d602011610ba0575b81610b916020938361065f565b810103126100e757515f610b12565b3d9150610b84565b6020919294610bde9460018060a01b0360808901511690519260405196879485938493630794e50360e01b8552600485016107c2565b03915afa9182156103e9575f92610c49575b5081610c03575b50505061010090610b1f565b61010093945060ff610c32610c23610c4095946109ec610c3a958c6107f8565b6109e68360c08a01511661083d565b92511661083d565b9061081f565b91905f80610bf7565b9091506020813d602011610c75575b81610c656020938361065f565b810103126100e75751905f610bf0565b3d9150610c58565b505050505090505f905f90565b610c94919761081f565b955f610a11565b5060ff6001610a07565b9093506020813d602011610cd1575b81610cc16020938361065f565b810103126100e75751925f6109cc565b3d9150610cb4565b50505050505090505f905f90565b5050505090505f905f90565b9150506040813d604011610d24575b81610d0f6040938361065f565b810103126100e757602081519101515f6108ea565b3d9150610d02565b610d38918101906106ab565b602063ffffffff60e01b825116928183015193610d696040519586938493639de7308560e01b8552600485016107c2565b03817f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165afa9182156103e9575f92610e61575b508115610e34576040015111610de8575f90604051610dc560408261065f565b60138152721315158818589bdd99481d1a1c995cda1bdb19606a1b602082015290565b600190604051610df960608261065f565b602581527f4c54562062656c6f77207468726573686f6c64202d20756e6465722d6c6576656020820152641c9859d95960da1b604082015290565b50505f90604051610e4660408261065f565b600b81526a2737903837b9b4ba34b7b760a91b602082015290565b9091506020813d602011610e8d575b81610e7d6020938361065f565b810103126100e75751905f610da5565b3d9150610e7056fea26469706673582212205cb9ef9264889e9f32806e709709b8f63845c2752d811e5ba07b1e930ff08fff64736f6c634300081e0033",
  "devdoc": {
    "details": "Opposite of LtvTrigger - increases leverage when under-leveraged Flow: 1. Pre-hook: Flash loan collateral → Deposit → Borrow debt → Push to OrderManager 2. CoW Swap: Debt → Collateral 3. Post-hook: Repay flash loan with received collateral Order params:   - sellToken = debtToken (we're selling borrowed debt)   - buyToken = collateralToken (we're buying collateral to repay flash loan)",
    "kind": "dev",
    "methods": {
      "calculateExecution(bytes,address)": {
        "details": "Returns:   - sellAmount: debt tokens to borrow and swap   - minBuyAmount: collateral tokens expected (must cover flash loan + fee)",
        "params": {
          "owner": "The order owner",
          "staticData": "ABI-encoded trigger-specific parameters"
        },
        "returns": {
          "minBuyAmount": "Minimum amount to receive (includes slippage protection)",
          "sellAmount": "Amount of sell token to trade in this execution"
        }
      },
      "isComplete(bytes,address,uint256)": {
        "details": "Auto-leverage orders are continuous - they never auto-complete. The order remains active and will re-trigger whenever LTV drops below the trigger threshold, up to maxIterations or until user cancels. This provides ongoing leverage management rather than one-shot execution.",
        "params": {
          "iterationCount": "Number of executions completed so far",
          "owner": "The order owner",
          "staticData": "ABI-encoded trigger-specific parameters"
        },
        "returns": {
          "_0": "True if the order goal has been reached"
        }
      },
      "shouldExecute(bytes,address)": {
        "params": {
          "owner": "The order owner (user whose position is being monitored)",
          "staticData": "ABI-encoded trigger-specific parameters"
        },
        "returns": {
          "_0": "True if the trigger condition is met",
          "_1": "Human-readable reason for the result (for debugging/logging)"
        }
      },
      "triggerName()": {
        "returns": {
          "_0": "Trigger name (e.g., \"LTV\", \"Price\", \"HealthFactor\")"
        }
      }
    },
    "title": "AutoLeverageTrigger",
    "version": 1
  },
  "userdoc": {
    "kind": "user",
    "methods": {
      "calculateExecution(bytes,address)": {
        "notice": "Calculate the execution amounts when the trigger fires"
      },
      "encodeTriggerParams((bytes4,bytes,uint256,uint256,address,address,uint8,uint8,uint256,uint8))": {
        "notice": "Encode trigger params for order creation"
      },
      "getCurrentLtv(bytes4,address,bytes)": {
        "notice": "Get current LTV for a user"
      },
      "isComplete(bytes,address,uint256)": {
        "notice": "Check if the order is complete and should stop executing"
      },
      "shouldExecute(bytes,address)": {
        "notice": "Check if the order should execute based on current conditions"
      },
      "triggerName()": {
        "notice": "Get human-readable name of the trigger type"
      }
    },
    "notice": "Triggers order execution when position LTV drops BELOW a threshold (auto-leverage)",
    "version": 1
  },
  "storageLayout": {
    "storage": [],
    "types": null
  }
}