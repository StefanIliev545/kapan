import{r as p}from"./index-Bk_d_yAU.js";import{j as y}from"./jsx-runtime-CcWEvojh.js";import{u as F,J as T,l as j}from"./createSafeContext-Dp97sAkz.js";import{o as W,l as O,C as K,m as N,q as P,r as S}from"./SelectedGasTokenContext-BLwdQCB-.js";import{E as M}from"./externalContracts-_f_8pMJw.js";import{u as z}from"./Constants-BRuV1-4o.js";import{C as $,y as H,z as A}from"./en_US-YBXRRIY6-ByhZuFgc.js";import{a as D}from"./TokenActionModal-DgAAeYOn.js";import{u as B}from"./useScaffoldMultiWriteContract-BRZiB8p-.js";import"./networks-DgHYYcb8.js";import{b as U,f as G}from"./protocols-CRHRSpKz.js";import"./store-CUKCto7f.js";import"./contract-CleVho0y.js";function J({title:e,titleId:t,...a},o){return p.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:o,"aria-labelledby":t},a),e?p.createElement("title",{id:t},e):null,p.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 12.75 6 6 9-13.5"}))}const _e=p.forwardRef(J);function Y(e){return t=>e(t.target.checked)}const E=({enabled:e,setEnabled:t,isLoaded:a})=>a?y.jsx("div",{className:"pb-1 pt-2",children:y.jsxs("label",{className:"label cursor-pointer justify-start gap-2",children:[y.jsx("input",{type:"checkbox",checked:e,onChange:Y(t),className:"checkbox checkbox-sm"}),y.jsx("span",{className:"label-text text-xs",children:"Batch Transactions with Smart Account"})]})}):null;try{E.displayName="BatchingPreference",E.__docgenInfo={description:"",displayName:"BatchingPreference",props:{enabled:{defaultValue:null,description:"",name:"enabled",required:!0,type:{name:"boolean"}},setEnabled:{defaultValue:null,description:"",name:"setEnabled",required:!0,type:{name:"(enabled: boolean) => void"}},isLoaded:{defaultValue:null,description:"",name:"isLoaded",required:!0,type:{name:"boolean"}}}}}catch{}const L=e=>e.toLowerCase(),I=e=>Array.isArray(e)?e:e?.result,Q=(e,t)=>{const{address:a}=F(),o=$({chainId:t}),c=!!(a&&o&&e.length>0);return T({queryKey:["wallet-token-balances","evm",t,a,e.map(s=>L(s.address))],enabled:c,staleTime:3e4,refetchInterval:3e4,queryFn:async()=>{if(!o||!a)return{};const s=[],n=[],r=[];e.forEach(l=>{n.push(s.length),s.push({address:l.address,abi:M,functionName:"balanceOf",args:[a]}),l.decimals===void 0?(r.push(s.length),s.push({address:l.address,abi:M,functionName:"decimals"})):r.push(null)});const u=await o.multicall({contracts:s,allowFailure:!0});return e.reduce((l,i,d)=>{const f=u[n[d]],m=f.status==="success"&&f.result!=null?BigInt(f.result):0n,h=r[d],b=h!=null?u[h]:null,g=i.decimals!==void 0?i.decimals:b?.status==="success"&&b.result!=null?Number(b.result):void 0;return l[L(i.address)]={balance:m,decimals:g},l},{})}})},X=e=>{const{address:t}=z(),{provider:a}=W(),o=!!(t&&a&&e.length>0);return T({queryKey:["wallet-token-balances","starknet",t,e.map(c=>L(c.address))],enabled:o,staleTime:3e4,refetchInterval:3e4,queryFn:async()=>{if(!a||!t)return{};const c=n=>{const r=I(n);if(!r||r.length===0)return 0n;if(r.length>=2){const u=BigInt(r[0]);return(BigInt(r[1])<<128n)+u}return BigInt(r[0])},s=await Promise.all(e.map(async n=>{const r=async()=>{try{const d=await a.callContract({contractAddress:n.address,entrypoint:"balance_of",calldata:[t]});return c(d)}catch(d){try{const f=await a.callContract({contractAddress:n.address,entrypoint:"balanceOf",calldata:[t]});return c(f)}catch(f){return console.warn("Failed to fetch Starknet balance for",n.address,d,f),0n}}},u=async()=>{if(n.decimals!==void 0)return n.decimals;try{const d=await a.callContract({contractAddress:n.address,entrypoint:"decimals",calldata:[]}),f=I(d)?.[0];return f!==void 0?Number(BigInt(f)):void 0}catch(d){console.warn("Failed to fetch Starknet decimals for",n.address,d);return}},[l,i]=await Promise.all([r(),u()]);return{balance:l,decimals:i}}));return e.reduce((n,r,u)=>{const{balance:l,decimals:i}=s[u];return n[L(r.address)]={balance:l,decimals:i},n},{})}})},Z=({tokens:e,network:t,chainId:a})=>{const c=(t==="stark"?"starknet":t)==="evm",s=Q(c?e:[],a),n=X(c?[]:e),r=c?s:n;return{balances:r.data??{},isLoading:r.isLoading||r.isFetching,refetch:r.refetch}},ee=(e,t="evm",a,o)=>{const c=t==="stark"?"starknet":t,{balances:s}=Z({tokens:[{address:e,decimals:o}],network:c,chainId:a}),n=L(e),r=s[n];return{balance:r?.balance??0n,decimals:r?.decimals??o}};function te(){return{action:"Deposit",apyLabel:"Supply APY",metricLabel:"Total supplied",before:0}}function ae({token:e,network:t,chainId:a}){const{balance:o,decimals:c}=ee(e.address,t,t==="evm"?a:void 0,e.decimals),s=e.decimals??c??18,n={...e,decimals:s};return e.decimals==null&&(e.decimals=s),{config:te(),balance:o,decimals:s,normalizedToken:n,network:t}}function re({isOpen:e,onClose:t,token:a,protocolName:o,position:c,renderProps:s,chainId:n,onConfirm:r,buildCalls:u,renderExtraContent:l}){const{config:i,balance:d,network:f,normalizedToken:m}=s;return{isOpen:e,onClose:t,action:i.action,token:m,protocolName:o,apyLabel:i.apyLabel,apy:a.currentRate,metricLabel:i.metricLabel,before:i.before,balance:d,network:f,chainId:n,position:c,onConfirm:r,buildCalls:u,renderExtraContent:l}}function ne(e,t,a={}){const{serialize:o=JSON.stringify,deserialize:c=JSON.parse,syncTabs:s=!0}=a,[n,r]=p.useState(t),[u,l]=p.useState(!1),i=p.useRef(!1);p.useEffect(()=>{if(!i.current){i.current=!0;try{const m=localStorage.getItem(e);m!==null&&r(c(m))}catch(m){console.warn(`[useLocalStorage] Failed to read "${e}":`,m)}finally{l(!0)}}},[e,c]),p.useEffect(()=>{if(!s)return;const m=h=>{if(h.key===e)try{h.newValue===null?r(t):r(c(h.newValue))}catch(b){console.warn(`[useLocalStorage] Failed to sync "${e}" from storage event:`,b)}};return window.addEventListener("storage",m),()=>window.removeEventListener("storage",m)},[e,t,c,s]);const d=p.useCallback(m=>{r(h=>{const b=typeof m=="function"?m(h):m;try{localStorage.setItem(e,o(b))}catch(g){console.warn(`[useLocalStorage] Failed to save "${e}":`,g)}return b})},[e,o]),f=p.useCallback(()=>{try{localStorage.removeItem(e),r(t)}catch(m){console.warn(`[useLocalStorage] Failed to remove "${e}":`,m)}},[e,t]);return[n,d,{isLoaded:u,remove:f}]}const se={serialize:e=>String(e),deserialize:e=>e==="true"},oe="kapan-batch-transactions-enabled",ce=!1,ie=()=>{const[e,t,{isLoaded:a}]=ne(oe,ce,se);return{enabled:e,setEnabled:t,isLoaded:a}},k=({isOpen:e,chainId:t,onClose:a,buildFlow:o,successMessage:c,emptyFlowErrorMessage:s="Failed to build transaction instructions",chainSwitchErrorMessage:n="Please switch to the selected network to proceed",simulateWhenBatching:r=!1,revokePermissions:u=!1})=>{const{chain:l}=F(),{switchChain:i}=H(),d=ie(),{executeFlowBatchedIfPossible:f,isAnyConfirmed:m,simulateInstructions:h}=B(),b=p.useCallback(async()=>{!t||!i||l?.id===t||await i({chainId:t})},[t,l?.id,i]);p.useEffect(()=>{e&&b().catch(w=>{console.warn("Auto network switch failed",w)})},[b,e]);const g=p.useCallback(async(w,x)=>{try{await b()}catch(C){throw A.error(n),C}const v=await o(w,x);if(!v||v.length===0){const C=new Error(s);throw A.error(C.message),C}if(r&&d.enabled)try{await h(v,{skipWhenAuthCallsExist:!0})}catch(C){throw A.error(C?.message||"Transaction simulation failed"),C}const _=u||d.enabled;await f(v,d.enabled,{revokePermissions:_})},[b,o,f,d.enabled,h,n,s,r,u]);return p.useEffect(()=>{m&&e&&a?.()},[m,e,a]),{handleConfirm:g,batchingPreference:d}},q=({isOpen:e,onClose:t,token:a,protocolName:o,position:c,chainId:s,context:n})=>{const{buildDepositFlow:r}=B(),u=o.toLowerCase(),l=ae({token:a,network:"evm",chainId:s}),{decimals:i}=l,d=p.useCallback(x=>r(u,a.address,x,a.decimals||i||18,n),[r,n,i,u,a.address,a.decimals]),{handleConfirm:f,batchingPreference:m}=k({isOpen:e,chainId:s,onClose:t,buildFlow:d,successMessage:"Deposit transaction sent",emptyFlowErrorMessage:"Failed to build deposit instructions"}),{enabled:h,setEnabled:b,isLoaded:g}=m,w=re({isOpen:e,onClose:t,token:a,protocolName:o,position:c,renderProps:l,chainId:s,onConfirm:f,renderExtraContent:()=>y.jsx(E,{enabled:h,setEnabled:b,isLoaded:g})});return y.jsx(D,{...w})};try{q.displayName="DepositModal",q.__docgenInfo={description:"",displayName:"DepositModal",props:{chainId:{defaultValue:null,description:"",name:"chainId",required:!1,type:{name:"number"}},context:{defaultValue:null,description:"Pre-encoded protocol context (e.g., Morpho MarketParams, Compound market address)",name:"context",required:!1,type:{name:"string"}},isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},token:{defaultValue:null,description:"",name:"token",required:!0,type:{name:"TokenInfo"}},protocolName:{defaultValue:null,description:"",name:"protocolName",required:!0,type:{name:"string"}},position:{defaultValue:null,description:"",name:"position",required:!1,type:{name:"PositionManager"}}}}}catch{}function le({token:e,supplyBalance:t}){const a=e.decimals??18,o=p.useMemo(()=>a?Number(j(t,a)):0,[a,t]),c=p.useMemo(()=>t*101n/100n,[t]),s=p.useMemo(()=>({action:"Withdraw",apyLabel:"Supply APY",metricLabel:"Total supplied",before:o,percentBase:t,max:c}),[o,t,c]);return{decimals:a,before:o,maxInput:c,commonModalProps:s}}const R=({isOpen:e,onClose:t,token:a,protocolName:o,supplyBalance:c,position:s,chainId:n,context:r})=>{const{buildWithdrawFlow:u}=B(),l=a.decimals,i=o.toLowerCase(),d=p.useCallback((v,_)=>u(i,a.address,v,a.decimals||l||18,_||!1,r),[u,r,l,i,a.address,a.decimals]),{handleConfirm:f,batchingPreference:m}=k({isOpen:e,chainId:n,onClose:t,buildFlow:d,successMessage:"Withdraw transaction sent",emptyFlowErrorMessage:"Failed to build withdraw instructions"}),{enabled:h,setEnabled:b,isLoaded:g}=m,{commonModalProps:w}=le({token:a,supplyBalance:c}),x=p.useCallback(()=>y.jsx(E,{enabled:h,setEnabled:b,isLoaded:g}),[h,b,g]);return y.jsx(D,{isOpen:e,onClose:t,...w,token:a,protocolName:o,apy:a.currentRate,balance:c,network:"evm",chainId:n,position:s,onConfirm:f,renderExtraContent:x})};try{R.displayName="WithdrawModal",R.__docgenInfo={description:"",displayName:"WithdrawModal",props:{isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},token:{defaultValue:null,description:"",name:"token",required:!0,type:{name:"TokenInfo"}},protocolName:{defaultValue:null,description:"",name:"protocolName",required:!0,type:{name:"string"}},supplyBalance:{defaultValue:null,description:"",name:"supplyBalance",required:!0,type:{name:"bigint"}},position:{defaultValue:null,description:"",name:"position",required:!1,type:{name:"PositionManager"}},chainId:{defaultValue:null,description:"",name:"chainId",required:!1,type:{name:"number"}},context:{defaultValue:null,description:"Pre-encoded protocol context (e.g., Morpho MarketParams, Compound market address)",name:"context",required:!1,type:{name:"string"}}}}}catch{}const Pe=()=>{const{account:e}=z(),{data:t}=U("RouterGateway");return{getAuthorizations:p.useCallback(async o=>{if(!e||!t)return[];const c=O.compile({instructions:o,rawSelectors:!1}),n=await new K({abi:t.abi,address:t.address,providerOrAccount:e}).call("get_authorizations_for_instructions",c),r=[];if(Array.isArray(n))for(const u of n){const l=N.toHexString(u[0]),i=G(u[1]);r.push({contractAddress:l,entrypoint:i,calldata:u[2].map(d=>N.toHexString(d))})}return r},[e,t]),isReady:!!e&&!!t}},Se=e=>{const t=N.toHexString(0n);return e.filter(a=>a.entrypoint==="modify_delegation"&&a.calldata.length>0).map(a=>({contractAddress:a.contractAddress,entrypoint:a.entrypoint,calldata:[...a.calldata.slice(0,-1),t]}))},de=e=>`0x${(typeof e=="bigint"?e.toString(16):e.replace(/^0x/i,"")).padStart(64,"0")}`,ue=e=>e.protocolKey==="vesu_v2",Ae=de,V=e=>typeof e=="bigint"?e:BigInt(e),Ve=e=>e?ue(e)?(console.log("v2 context",e),new P(S.Some,[V(e.poolAddress),V(e.positionCounterpartToken)])):new P(S.Some,[e.poolId,V(e.counterpartToken)]):new P(S.None);export{E as B,q as D,_e as F,R as W,ee as a,Pe as b,Y as c,Ve as d,Se as e,ae as f,re as g,le as h,k as i,Ae as n,ie as u};
